<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Monte Carlo power evaluation for experimental designs with user-supplied libraries — eval_design_custom_mc • skpr</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Monte Carlo power evaluation for experimental designs with user-supplied libraries — eval_design_custom_mc"><meta name="description" content="Evaluates the power of an experimental design, given its run matrix and the
statistical model to be fit to the data, using monte carlo simulation. Simulated data is fit using a
user-supplied fitting library and power is estimated by the fraction of times a parameter is significant. Returns
a data frame of parameter powers."><meta property="og:description" content="Evaluates the power of an experimental design, given its run matrix and the
statistical model to be fit to the data, using monte carlo simulation. Simulated data is fit using a
user-supplied fitting library and power is estimated by the fraction of times a parameter is significant. Returns
a data frame of parameter powers."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">skpr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.8.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tylermorganwall/skpr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Monte Carlo power evaluation for experimental designs with user-supplied libraries</h1>
      <small class="dont-index">Source: <a href="https://github.com/tylermorganwall/skpr/blob/master/R/eval_design_custom_mc.R" class="external-link"><code>R/eval_design_custom_mc.R</code></a></small>
      <div class="d-none name"><code>eval_design_custom_mc.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Evaluates the power of an experimental design, given its run matrix and the
statistical model to be fit to the data, using monte carlo simulation. Simulated data is fit using a
user-supplied fitting library and power is estimated by the fraction of times a parameter is significant. Returns
a data frame of parameter powers.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">eval_design_custom_mc</span><span class="op">(</span></span>
<span>  <span class="va">design</span>,</span>
<span>  model <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  <span class="va">nsim</span>,</span>
<span>  <span class="va">rfunction</span>,</span>
<span>  <span class="va">fitfunction</span>,</span>
<span>  <span class="va">pvalfunction</span>,</span>
<span>  <span class="va">anticoef</span>,</span>
<span>  effectsize <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="va">contr.sum</span>,</span>
<span>  coef_function <span class="op">=</span> <span class="va">coef</span>,</span>
<span>  calceffect <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  detailedoutput <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  parameternames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  advancedoptions <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  parallel_pkgs <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-design">design<a class="anchor" aria-label="anchor" href="#arg-design"></a></dt>
<dd><p>The experimental design. Internally, <code>eval_design_custom_mc</code> rescales each numeric column
to the range [-1, 1].</p></dd>


<dt id="arg-model">model<a class="anchor" aria-label="anchor" href="#arg-model"></a></dt>
<dd><p>The model used in evaluating the design. If this is missing and the design
was generated with skpr, the generating model will be used. It can be a subset of the model used to
generate the design, or include higher order effects not in the original design generation. It cannot include
factors that are not present in the experimental design.</p></dd>


<dt id="arg-alpha">alpha<a class="anchor" aria-label="anchor" href="#arg-alpha"></a></dt>
<dd><p>Default `0.05`. The type-I error. p-values less than this will be counted as significant.</p></dd>


<dt id="arg-nsim">nsim<a class="anchor" aria-label="anchor" href="#arg-nsim"></a></dt>
<dd><p>The number of simulations.</p></dd>


<dt id="arg-rfunction">rfunction<a class="anchor" aria-label="anchor" href="#arg-rfunction"></a></dt>
<dd><p>Random number generator function. Should be a function of the form f(X, b), where X is the
model matrix and b are the anticipated coefficients.</p></dd>


<dt id="arg-fitfunction">fitfunction<a class="anchor" aria-label="anchor" href="#arg-fitfunction"></a></dt>
<dd><p>Function used to fit the data. Should be of the form f(formula, X, contrasts)
where X is the model matrix. If contrasts do not need to be specified for the user supplied
library, that argument can be ignored.</p></dd>


<dt id="arg-pvalfunction">pvalfunction<a class="anchor" aria-label="anchor" href="#arg-pvalfunction"></a></dt>
<dd><p>Function that returns a vector of p-values from the object returned from the fitfunction.</p></dd>


<dt id="arg-anticoef">anticoef<a class="anchor" aria-label="anchor" href="#arg-anticoef"></a></dt>
<dd><p>The anticipated coefficients for calculating the power. If missing, coefficients will be
automatically generated based on <code>effectsize</code>.</p></dd>


<dt id="arg-effectsize">effectsize<a class="anchor" aria-label="anchor" href="#arg-effectsize"></a></dt>
<dd><p>The signal-to-noise ratio. Default 2. For a gaussian model, and for
continuous factors, this specifies the difference in response between the highest
and lowest levels of a factor (which are +1 and -1 after normalization).
More precisely: If you do not specify <code>anticoef</code>, the anticipated coefficients will be
half of <code>effectsize</code>. If you do specify <code>anticoef</code>, <code>effectsize</code> will be ignored.</p></dd>


<dt id="arg-contrasts">contrasts<a class="anchor" aria-label="anchor" href="#arg-contrasts"></a></dt>
<dd><p>Default <code>contr.sum</code>. Function used to generate the contrasts encoding for categorical variables. If the user has specified their own contrasts
for a categorical factor using the contrasts function, those will be used. Otherwise, skpr will use contr.sum.</p></dd>


<dt id="arg-coef-function">coef_function<a class="anchor" aria-label="anchor" href="#arg-coef-function"></a></dt>
<dd><p>Function that, when applied to a fitfunction return object, returns the estimated coefficients.</p></dd>


<dt id="arg-calceffect">calceffect<a class="anchor" aria-label="anchor" href="#arg-calceffect"></a></dt>
<dd><p>Default `FALSE`. Calculates effect power for a Type-III Anova (using the car package) using a Wald test.
this ratio can be a vector specifying the variance ratio for each subplot. Otherwise, it will use a single value for all strata. To work, the
fit returned by `fitfunction` must have a method compatable with the car package.</p></dd>


<dt id="arg-detailedoutput">detailedoutput<a class="anchor" aria-label="anchor" href="#arg-detailedoutput"></a></dt>
<dd><p>Default `FALSE`. If `TRUE`, return additional information about evaluation in results.</p></dd>


<dt id="arg-parameternames">parameternames<a class="anchor" aria-label="anchor" href="#arg-parameternames"></a></dt>
<dd><p>Vector of parameter names if the coefficients do not correspond simply to the columns in the model matrix
(e.g. coefficients from an MLE fit).</p></dd>


<dt id="arg-advancedoptions">advancedoptions<a class="anchor" aria-label="anchor" href="#arg-advancedoptions"></a></dt>
<dd><p>Default `NULL`. Named list of advanced options. `advancedoptions$anovatype` specifies the Anova type in the car package (default type `III`),
user can change to type `II`). `advancedoptions$anovatest` specifies the test statistic if the user does not want a `Wald` test–other options are likelyhood-ratio `LR` and F-test `F`.
`advancedoptions$progressBarUpdater` is a function called in non-parallel simulations that can be used to update external progress bar.`advancedoptions$GUI` turns off some warning messages when in the GUI.
If `advancedoptions$save_simulated_responses = TRUE`, the dataframe will have an attribute `simulated_responses` that contains the simulated responses from the power evaluation. `advancedoptions$ci_error_conf` will
set the confidence level for power intervals, which are printed when `detailedoutput = TRUE`.</p></dd>


<dt id="arg-progress">progress<a class="anchor" aria-label="anchor" href="#arg-progress"></a></dt>
<dd><p>Default `TRUE`. Whether to include a progress bar.</p></dd>


<dt id="arg-parallel">parallel<a class="anchor" aria-label="anchor" href="#arg-parallel"></a></dt>
<dd><p>Default `FALSE`. If `TRUE`, the power simulation will use all but one of the available cores.
If the user wants to set the number of cores manually, they can do this by setting `options("cores")` to the desired number (e.g. `options("cores" = parallel::detectCores())`).
NOTE: If you have installed BLAS libraries that include multicore support (e.g. Intel MKL that comes with Microsoft R Open), turning on parallel could result in reduced performance.</p></dd>


<dt id="arg-parallel-pkgs">parallel_pkgs<a class="anchor" aria-label="anchor" href="#arg-parallel-pkgs"></a></dt>
<dd><p>A vector of strings listing the external packages to be included in each parallel worker.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data frame consisting of the parameters and their powers. The parameter estimates from the simulations are
stored in the 'estimates' attribute.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">#To demonstrate how a user can use their own libraries for Monte Carlo power generation,</span></span></span>
<span class="r-in"><span><span class="co">#We will recreate eval_design_survival_mc using the eval_design_custom_mc framework.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#To begin, first let us generate the same design and random generation function shown in the</span></span></span>
<span class="r-in"><span><span class="co">#eval_design_survival_mc examples:</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">basicdesign</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>,<span class="st">"b"</span>,<span class="st">"c"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="gen_design.html">gen_design</a></span><span class="op">(</span>candidateset <span class="op">=</span> <span class="va">basicdesign</span>, model <span class="op">=</span> <span class="op">~</span><span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">a</span><span class="op">:</span><span class="va">b</span>, trials <span class="op">=</span> <span class="fl">100</span>,</span></span>
<span class="r-in"><span>                         optimality <span class="op">=</span> <span class="st">"D"</span>, repeats <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#Random number generating function</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">rsurvival</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">b</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span> <span class="va">Y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="va">censored</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">&gt;</span> <span class="fl">1</span></span></span>
<span class="r-in"><span> <span class="va">Y</span><span class="op">[</span><span class="va">censored</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">Y</span>, event <span class="op">=</span> <span class="op">!</span><span class="va">censored</span>, type <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#We now need to tell the package how we want to fit our data,</span></span></span>
<span class="r-in"><span><span class="co">#given the formula and the model matrix X (and, if needed, the list of contrasts).</span></span></span>
<span class="r-in"><span><span class="co">#If the contrasts aren't required, "contrastslist" should be set to NULL.</span></span></span>
<span class="r-in"><span><span class="co">#This should return some type of fit object.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">fitsurv</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">X</span>, <span class="va">contrastslist</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html" class="external-link">survreg</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">X</span>, dist <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#We now need to tell the package how to extract the p-values from the fit object returned</span></span></span>
<span class="r-in"><span><span class="co">#from the fit function. This is how to extract the p-values from the survreg fit object:</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">pvalsurv</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">$</span><span class="va">table</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#And now we evaluate the design, passing the fitting function and p-value extracting function</span></span></span>
<span class="r-in"><span><span class="co">#in along with the standard inputs for eval_design_mc.</span></span></span>
<span class="r-in"><span><span class="co">#This has the exact same behavior as eval_design_survival_mc for the exponential distribution.</span></span></span>
<span class="r-in"><span><span class="fu">eval_design_custom_mc</span><span class="op">(</span>design <span class="op">=</span> <span class="va">design</span>, model <span class="op">=</span> <span class="op">~</span><span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">a</span><span class="op">:</span><span class="va">b</span>,</span></span>
<span class="r-in"><span>                     alpha <span class="op">=</span> <span class="fl">0.05</span>, nsim <span class="op">=</span> <span class="fl">100</span>,</span></span>
<span class="r-in"><span>                     fitfunction <span class="op">=</span> <span class="va">fitsurv</span>, pvalfunction <span class="op">=</span> <span class="va">pvalsurv</span>,</span></span>
<span class="r-in"><span>                     rfunction <span class="op">=</span> <span class="va">rsurvival</span>, effectsize <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     parameter                      type power</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 (Intercept) custom.parameter.power.mc  0.83</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2           a custom.parameter.power.mc  0.77</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3          b1 custom.parameter.power.mc  0.27</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4          b2 custom.parameter.power.mc  0.64</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5        a:b1 custom.parameter.power.mc  0.26</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6        a:b2 custom.parameter.power.mc  0.54</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ===============Evaluation Info===============</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="font-weight: bold;">• Alpha = </span>0.05 <span style="font-weight: bold;">• Trials = </span>100 <span style="font-weight: bold;">• Blocked = </span>FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="font-weight: bold;">• Evaluating Model = </span>~a + b + a:b </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="font-weight: bold;">• Anticipated Coefficients = </span>c(0.500, 0.500, 0.500, -0.500, 0.500, -0.500) </span>
<span class="r-in"><span><span class="co">#We can also use skpr's framework for parallel computation to automatically parallelize this</span></span></span>
<span class="r-in"><span><span class="co">#to speed up computation</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="fu">eval_design_custom_mc</span><span class="op">(</span>design <span class="op">=</span> <span class="va">design</span>, model <span class="op">=</span> <span class="op">~</span><span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">a</span><span class="op">:</span><span class="va">b</span>,</span></span>
<span class="r-in"><span>                         alpha <span class="op">=</span> <span class="fl">0.05</span>, nsim <span class="op">=</span> <span class="fl">1000</span>,</span></span>
<span class="r-in"><span>                         fitfunction <span class="op">=</span> <span class="va">fitsurv</span>, pvalfunction <span class="op">=</span> <span class="va">pvalsurv</span>,</span></span>
<span class="r-in"><span>                         rfunction <span class="op">=</span> <span class="va">rsurvival</span>, effectsize <span class="op">=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>                         parallel <span class="op">=</span> <span class="cn">TRUE</span>, parallel_pkgs <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="co"># \dontrun{}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tyler Morgan-Wall, George Khoury.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

